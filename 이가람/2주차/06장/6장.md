# 06 데이터 압축
- 디스크에 저장된 데이터의 크기는 일반적으로 쿼리의 성능, 백업 및 복구 시간과도 밀접하게 연결되는데 DBMS 에서는 이런 데이터의 크기를 줄이기 위해 **데이터 압축** 이라는 기능을 제공한다.
- MySQL 에서는 크게 **테이블 압축** 과 **페이지 압축** 의 두 종류로 구분한다.

## 6.1 페이지 압축(Transparent Page Compression)
- 디스크 저장 시점에 페이지가 압축되고, 디스크에서 데이터 페이지를 읽어올 때 압축이 해제된다.
- 버퍼 풀에 한번 적재되면 InnoDB 스토리지 엔진은 압축이 해제된 데이터 페이지 만을 관리한다.

- 페이지 압축은 운영체제에서 지원하는 **펀치 홀(Punch hole)** 이라는 기능을 사용한다.
  > 1. 페이지를 압축한다.
  > 2. MySQL 서버는 압축된 데이터를 기록한다.
  > 3. 1번에서 압축 후 남은 공간에 대해 펀치 홀을 생성한다.
  > 4. 나머지 공간을 운영체제에 반납한다.
- 실제 디스크 공간은 압축된 결과만 차지하지만 운영체제에서는 압축되기 전의 공간까지 읽는다.
- 펀치 홀 기능은 **운영체제와 하드웨어 모두 지원해야 사용 가능**하고 파일 시스템 관련 명령어가 펀치홀을 지원하지 못해 많이 사용되지 않는다.

## 6.2 테이블 압축
- 페이지 압축과 다르게 **운영체제나 하드웨어에 대한 제약 없이 사용**할 수 있다.
- 디스크의 데이터 파일 크기를 줄일 수 있지만 아래의 단점이 있다.
    - 버퍼 풀 공간 활용률이 낮음
    - 쿼리 처리 성능이 낮음
    - 빈번한 데이터 변경 시 압축률이 떨어짐


### 6.2.1 압축 테이블 생성
- 테이블 압축의 전제 조건은 압축 하려는 테이블이 별도의 테이블 스페이스를 사용해야한다.
  > 테이블 스페이스: 데이터와 인덱스를 물리적으로 저장하는데 사용하는 공간
- InnoDB 의 테이블 압축 방법: 원본 데이터 페이지의 **압축 결과**가 **목표 크기**보다 **작거나 같아**질 때 까지 **나눠서 압축을 진행**한다.
  > 1. 데이터 페이지를 압축
  > 2. 압축된 결과가 목표 크기(KEY_BLOCK_SIZE) 보다 클 경우 페이지를 두 개로 나눠 압축을 다시 진행
  > 3. 압축된 결과가 목표 크기보다 작을 경우 그대로 디스크에 저장

### 6.2.2 KEY_BLOCK_SIZE 설정
- 테이블 압축에서 중요한 부분은 압축될 사이즈를 예측해 목표 크기를 지정하는 것이다.
- 압축 실패율이 높다면 압축 과정이 오래 걸린다고 예측할 수 있지만 압축 실패율이 테이블 압축 여부를 결정하지는 않는다.
- 데이터가 빈번하게 조회되고 변경된다면 압축을 사용하지 않는게 성능에 더 좋을 수 있다.

### 6.2.3. 압축된 페이지의 버퍼 풀 적재 및 사용
- InnoDB 스토리지 엔진은 압축된 테이블을 **압축된 상태** 와 **압축이 해제된 상태** 로 관리
- LRU 리스트에서는 압축이되지 않은 테이블의 데이터, 압축이 적용된 테이블의 압축 데이터 를 관리
- Unzip_LRU 리스트는 압축된 페이지들의 압축 해제 데이터를 관리


- LRU 리스트로 인해 버퍼풀의 공간을 이중으로 사용하고, 압축된 페이지를 읽고 쓸때 CPU를 많이 소모한다는 단점이 있다.


- 단점을 보완하기 위해 Unzip_LRU 리스트를 별도로 관리하다 요청에 따라 적절히 처리한다.
> - 버퍼풀의 공간이 필요하면 압축된 원본 데이터 페이지는 유지, Unzip_LRU 리스트에서 압축 해제된 버전을 제거해 공간을 확보한다.
> - 압축된 데이터가 자주 사용되는 경우 Unzip_LRU 리스트에 압축 해제된 페이지를 계속 유지
> - 압축된 페이지 미사용으로 LRU에서 제거시 Unzip_LRU 리스트에서도 제거


### 6.2.4 테이블 압축 관련 설정
- innodb_cmp_per_index_enabled: 압축 성공 및 압축 실행 횟수를 수집하도록 설정
- innodb_compression_level: 압축률을 설정해 속도, 저장 공간을 선택할 수 있다.
    - 압축률의 값이 작을록 속도↑, 저장공간↑ / 클수록 속도↓, 저장공간↓
- innodb_compression_failure_threshold_pct/innodb_compression_pad_pct_max: 실패율이 설정값보다 커지면 원본 데이터 끝에 빈공간을 추가해 압축 결과가 KEY_BLOCK_SIZE 보다 작아지게 한든다.
    - 이러한 빈공간을 패딩이라 한다.
- innodb_log_compressed_pages: 서버가 비정상적으로 종료되었다 다시 시작할 경우 복구 과정에서 실패하지 않도록 InnoDB 스토리지 엔진은 압축된 데이터를 페이지 그대로 리두로그에 기록하게 한다